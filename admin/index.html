<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | MacOne Burger Shop</title>

    <link rel="stylesheet" href="../styles/admin.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
    <div id="login" class="active">
        <h1>Painel de administrador</h1>
        <form id="login-form">
            <div class="mb-3">
                <label for="email" class="form-label">E-mail</label>
                <input type="email" name="email" id="email" class="form-control" required>
            </div>

            <div class="input-wrapper">
                <label for="password" class="form-label">Senha</label>
                <input type="password" id="password" class="form-control" required>
            </div>

            <div class="mb-3" style="margin-top: 20px;">
                <button type="submit" class="btn btn-primary">Entrar</button>
            </div>
        </form>
    </div>

    <div id="page">
        <div class="page-actions">
            <button class="btn btn-danger" id="logout-button">Sair</button>
        </div>
        <h2>Novo produto</h2>
        <hr>
        <div class="post-wrapper">
            <form id="post-product">
                <div class="mb-3">
                    <label for="produto" class="form-label">Nome do produto</label>
                    <input type="text" class="form-control" name="produto" id="produto" required>
                </div>

                <div class="mb-3">
                    <label for="preco" class="form-label">Preço</label>
                    <input type="number" class="form-control" name="preco" id="preco" required>
                </div>

                <div class="mb-3">
                    <label for="categoria" class="form-label">Categoria</label>
                    <select class="form-select" id="categoria" name="categoria" aria-label="Escolher uma categoria">
                        <option disabled selected>Escolha uma categoria</option>
                        <option value="default">Padrão</option>
                        <option value="sobremesa">Sobremesas</option>
                        <option value="bebidas">Bebidas</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="desc" class="form-label">Descrição do produto</label>
                    <textarea class="form-control" id="desc" name="desc" rows="3" required></textarea>
                </div>

                <div class="mb-3">
                    <label for="imagem" class="form-label">Imagem do produto</label>
                    <input class="form-control" type="file" id="imagem" name="imagem" accept="image/*" required>
                </div>

                <button type="submit" class="btn btn-primary">Cadastrar</button>
            </form>
        </div>

        <h2>Produtos cadastrados</h2>
        <hr>
        <div class="all-products">
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">Nome</th>
                        <th scope="col">Preço</th>
                        <th scope="col">Categoria</th>
                        <th scope="col">Ação</th>
                    </tr>
                </thead>
                <tbody id="produtos">
                </tbody>
            </table>
        </div>

        <footer>
            <p>Powered by <a href="https://www.github.com/imacod3r" target="_blank">Imacod3r</a></p>
        </footer>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-product">
                        <div class="mb-3">
                            <label for="produto" class="form-label">Nome do produto</label>
                            <input type="text" class="form-control" name="produto" id="produto" required>
                        </div>

                        <div class="mb-3">
                            <label for="preco" class="form-label">Preço</label>
                            <input type="number" class="form-control" name="preco" id="preco" required>
                        </div>

                        <div class="mb-3">
                            <label for="categoria" class="form-label">Categoria</label>
                            <select class="form-select" id="categoria" name="categoria"
                                aria-label="Escolher uma categoria">
                                <option disabled selected>Escolha uma categoria</option>
                                <option value="default">Padrão</option>
                                <option value="sobremesa">Sobremesas</option>
                                <option value="bebidas">Bebidas</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="desc" class="form-label">Descrição do produto</label>
                            <textarea class="form-control" id="desc" name="desc" rows="3" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="display" class="form-label">Imagem</label>
                            <img id="display" width="128px" height="128px" style="display: block; object-fit: fill;">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-button">Salvar alterações</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"></script>

<!-- Importando o SDK principal do Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>

<!-- Importando o Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<!-- Importando o Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- Importando o Firebase Storage -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDkm2zyEp7tZP3ddbJj-EQrk7cHpB-JcIk",
        authDomain: "macone-burger-shop.firebaseapp.com",
        projectId: "macone-burger-shop",
        storageBucket: "macone-burger-shop.appspot.com",
        messagingSenderId: "1033806358140",
        appId: "1:1033806358140:web:1ecd20cefc0b317aa54bf9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Instanciar as ferramentas
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Autenticar admin
    const loginForm = document.getElementById("login-form");
    loginForm.addEventListener("submit", (e) => {
        e.preventDefault();

        let email = e.target.elements.email.value;
        let password = e.target.elements.password.value;

        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                // Login bem-sucedido
                document.getElementById("login").classList.remove('active');
                document.getElementById("page").classList.add("active");

                loginForm.reset()
            })
            .catch((error) => {
                var errorCode = error.code;
                var errorMessage = error.message;
                console.error("Erro ao fazer login:", errorCode, errorMessage);
            });
    })

    // Verificar admin autenticado
    auth.onAuthStateChanged((user) => {
        if (user) {
            // Usuário está logado
            document.getElementById("login").classList.remove('active');
            document.getElementById("page").classList.add("active");
        } else {
            // Usuário não está logado
            document.getElementById("login").classList.add('active');
            document.getElementById("page").classList.remove("active");
        }
    });

    // Logout
    function logout() {
        auth.signOut().then(() => {
            document.getElementById("login").classList.remove('active');
            document.getElementById("page").classList.add("active");
        }).catch((error) => {
            console.error("Erro ao deslogar:", error);
        });
    }

    const logoutBtn = document.getElementById("logout-button");
    logoutBtn.addEventListener("click", logout);

    // Adicionar produtos ao banco
    function AdicionarProduto(produto) {
        db.collection("produtos").add(produto).then((docRef) => {
            console.log("Produto adicionado com sucesso!");
        }).catch((error) => {
            console.error("Erro ao adicionar produto: ", error);
        })
    }

    const produtoForm = document.getElementById("post-product");
    produtoForm.addEventListener("submit", (e) => {
        e.preventDefault();

        // Primeiro, faz o upload da imagem e obtém a URL
        UploadImage().then((imagemProduto) => {
            // Depois de obter a URL, cria o objeto de produto
            let newProduct = {
                nomeProduto: e.target.elements.produto.value,
                precoProduto: e.target.elements.preco.value,
                categoriaProduto: e.target.elements.categoria.value,
                descricaoProduto: e.target.elements.desc.value,
                imagemProduto: imagemProduto
            };

            // Chama a função para adicionar o produto ao Firestore
            AdicionarProduto(newProduct);

            // Limpar formulario
            produtoForm.reset();

        }).catch((error) => {
            console.error("Erro ao carregar a imagem ou salvar o produto:", error);
        });


    });

    // Upload de imagem
    function UploadImage() {
        return new Promise((resolve, reject) => {
            var file = document.getElementById("imagem").files[0];

            if (file) {
                // Referência ao armazenamento
                var storageRef = storage.ref('uploads/' + file.name);

                // Fazendo o upload do arquivo
                var uploadTask = storageRef.put(file);

                uploadTask.on('state_changed',
                    function (snapshot) {
                        // Progresso do upload (em porcentagem)
                        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Progresso do upload: ' + progress + '%');
                    },
                    function (error) {
                        // Tratar erros de upload
                        console.error('Erro no upload:', error);
                        reject(error);
                    },
                    function () {
                        // Upload completo, obtendo a URL de download
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            console.log('URL do arquivo:', downloadURL);
                            resolve(downloadURL);
                        }).catch((error) => {
                            console.error('Erro ao obter URL de download:', error);
                            reject(error);
                        });
                    }
                );
            } else {
                reject(new Error("Nenhum arquivo foi selecionado"));
            }
        });
    }

    // Listar produtos
    function mostrarProdutos() {
        // Escuta em tempo real para a coleção "produtos"
        db.collection("produtos").onSnapshot(function (querySnapshot) {
            var produtos = []; // Array para armazenar os dados

            querySnapshot.forEach(function (doc) {
                // Adiciona cada documento ao array
                produtos.push({ id: doc.id, ...doc.data() });
            });

            // Exibe os dados no elemento "tabela de produtos"
            var tabelaProdutos = document.getElementById("produtos");
            tabelaProdutos.innerHTML = ''; // Limpa o conteúdo atual

            produtos.forEach((produto) => {
                // Cria uma linha para cada produto
                var row = document.createElement('tr');
                row.innerHTML = `
                <td>${produto.nomeProduto}</td>
                <td>${produto.precoProduto}</td>
                <td>${produto.categoriaProduto}</td>
                <td>
                    <button class="btn btn-secondary" id="edit-button-${produto.id}" data-bs-toggle="modal" data-bs-target="#exampleModal">Editar</button>
                    <button class="btn btn-danger" id="delete-button-${produto.id}">Deletar</button>
                </td>
            `;
                tabelaProdutos.appendChild(row);

                // Associar o evento de clique ao botão de editar
                document.getElementById(`edit-button-${produto.id}`).addEventListener("click", () => {
                    EditarProduto(produto.id);
                });

                // Associar o evento de clique ao botão de deletar
                document.getElementById(`delete-button-${produto.id}`).addEventListener("click", () => {
                    DeletarProduto(produto.id);
                });

            });
        }, function (error) {
            console.log("Erro ao obter documentos: ", error);
        });
    }

    // Função para editar um produto
    function EditarProduto(produtoId) {
        var editForm = document.getElementById("edit-product");

        // Referência ao documento
        var docRef = db.collection("produtos").doc(produtoId);

        // Recupera o documento
        docRef.get().then(function (doc) {
            if (doc.exists) {
                let produto = doc.data();
                console.log("Produto:", produto);

                // Carregar dados nos campos de input
                editForm.elements.produto.value = produto.nomeProduto;
                editForm.elements.preco.value = produto.precoProduto;
                editForm.elements.categoria.value = produto.categoriaProduto;
                editForm.elements.desc.value = produto.descricaoProduto;

                // Carregar imagem
                var imagem = document.getElementById("display");
                imagem.src = produto.imagemProduto;

                // Salvar alterações no banco
                let saveBtn = document.getElementById("save-button");
                saveBtn.addEventListener("click", () => {
                    db.collection("produtos").doc(produtoId).update({
                        nomeProduto: editForm.elements.produto.value,
                        precoProduto: editForm.elements.preco.value,
                        categoriaProduto: editForm.elements.categoria.value,
                        descricaoProduto: editForm.elements.desc.value
                    }).then(() => editForm.reset())
                });

            }
            else {
                console.log("Nenhum documento encontrado com o ID fornecido.");
            }
        }).catch(function (error) {
            console.log("Erro ao obter documento:", error);
        });
    }


    // Função para deletar um produto
    function DeletarProduto(produtoId) {
        db.collection("produtos").doc(produtoId).delete().then(() => {
            console.log("Produto deletado com sucesso!");
        }).catch((error) => {
            console.error("Erro ao deletar produto: ", error);
        });
    }

    // Chama a função para mostrar os produtos ao carregar a página
    mostrarProdutos();

</script>